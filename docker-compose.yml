# This file is auto-generated by the Mailu configuration wizard.
# Please read the documentation before attempting any change.
# Generated for compose flavor


services:
  # External dependencies
  redis:
    container_name: redis
    image: redis:alpine
    hostname: redis
    restart: always
    volumes:
      - "./redis:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.200.254
    networks:
      - mail_internal


  # Core services
  front:
    container_name: front
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}nginx:${MAILU_VERSION:-2024.06}
    hostname: front
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-front
    networks:
      - mail_internal
      - traefik_network
    volumes:
      - "./dkim:/dkim"
      - "./certs:/certs"
    depends_on:
      - resolver
    dns:
      - 192.168.200.254
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_network"
      # Web interface (SnappyMail, Admin, etc.)
      - "traefik.http.routers.mailu.rule=Host(`mail.roudin.de`)"
      - "traefik.http.routers.mailu.entrypoints=WEBSECURE"
      - "traefik.http.routers.mailu.tls=true"
      - "traefik.http.routers.mailu.tls.certresolver=LETS_ENCRYPT_RESOLVER"
      - "traefik.http.routers.mailu.service=mailu-service"
      - "traefik.http.services.mailu-service.loadbalancer.server.port=80"
      # TLS aktivieren f√ºr roudin.de (damit kein Fehler angezeigt wird)
      - "traefik.http.routers.roudin.rule=Host(`roudin.de`)"
      - "traefik.http.routers.roudin.entrypoints=WEBSECURE"
      - "traefik.http.routers.roudin.tls=true"
      - "traefik.http.routers.roudin.tls.certresolver=LETS_ENCRYPT_RESOLVER"
      - "traefik.http.routers.roudin.middlewares=redirect-mail"
      - "traefik.http.routers.roudin.service=dummy-empty"
      # Weiterleitung zu mail.roudin.de
      - "traefik.http.middlewares.redirect-mail.redirectregex.regex=^https?://roudin.de/(.*)"
      - "traefik.http.middlewares.redirect-mail.redirectregex.replacement=https://mail.roudin.de/$1"
      - "traefik.http.middlewares.redirect-mail.redirectregex.permanent=true"
      # Dummy service (Pflicht wenn kein echter Dienst)
      - "traefik.http.services.dummy-empty.loadbalancer.server.url=http://127.0.0.1"
      # IMAPS (993)
      - "traefik.tcp.routers.mailu-imaps.rule=HostSNI(`mail.roudin.de`) || HostSNI(`imap.roudin.de`)"
      - "traefik.tcp.routers.mailu-imaps.entryPoints=IMAPS"
      - "traefik.tcp.routers.mailu-imaps.tls.passthrough=true"
      - "traefik.tcp.routers.mailu-imaps.service=imaps@docker"
      - "traefik.tcp.services.mailu-imaps.loadbalancer.server.address=993"
      # POP3S (995)
      - "traefik.tcp.routers.mailu-pop3s.rule=HostSNI(`mail.roudin.de`) || HostSNI(`pop3.roudin.de`)"
      - "traefik.tcp.routers.mailu-pop3s.entryPoints=POP3S"
      - "traefik.tcp.routers.mailu-pop3s.tls.passthrough=true"
      - "traefik.tcp.routers.mailu-pop3s.service=pop3s@docker"
      - "traefik.tcp.services.mailu-pop3s.loadbalancer.server.address=995"
      # SMTPS (465)
      - "traefik.tcp.routers.mailu-smtps.rule=HostSNI(`mail.roudin.de`) || HostSNI(`smtp.roudin.de`)"
      - "traefik.tcp.routers.mailu-smtps.entryPoints=SMTPS"
      - "traefik.tcp.routers.mailu-smtps.tls.passthrough=true"
      - "traefik.tcp.routers.mailu-smtps.service=smtps@docker"
      - "traefik.tcp.services.smtps.loadbalancer.server.port=465"
      # SMTP Submission (587)
      - "traefik.tcp.routers.smtp-submission.rule=HostSNI(`mail.roudin.de`)"
      - "traefik.tcp.routers.smtp-submission.entrypoints=SMTP_SUBMISSION"
      - "traefik.tcp.routers.smtp-submission.tls.passthrough=true"
      - "traefik.tcp.routers.smtp-submission.service=smtp-submission@docker"
      - "traefik.tcp.services.smtp-submission.loadbalancer.server.port=587"
      # SIEVE (4190)
      - "traefik.tcp.routers.mailu-sieve.rule=HostSNI(`mail.roudin.de`)"
      - "traefik.tcp.routers.mailu-sieve.entrypoints=SIEVE"
      - "traefik.tcp.routers.mailu-sieve.tls.passthrough=true"
      - "traefik.tcp.routers.mailu-sieve.service=sieve@docker"
      - "traefik.tcp.services.mailu-sieve.loadbalancer.server.port=4190"
      # SMTP (25) - Empfang mit STARTTLS
      - "traefik.tcp.routers.mailu-smtp.rule=HostSNI(`*`)"
#      - "traefik.tcp.routers.mailu-smtp.rule=HostSNI(`mail.roudin.de`) || HostSNI(`smtp.roudin.de`)"
      - "traefik.tcp.routers.mailu-smtp.entrypoints=SMTP"
#      - "traefik.tcp.routers.mailu-smtp.tls=true"
#      - "traefik.tcp.routers.mailu-smtp.tls.options=STARTTLS"
      - "traefik.tcp.routers.mailu-smtp.tls.passthrough=true"
      - "traefik.tcp.routers.mailu-smtp.service=smtp@docker"
      - "traefik.tcp.services.mailu-smtp.loadbalancer.server.port=25"

  resolver:
    container_name: resolver
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}unbound:${MAILU_VERSION:-2024.06}
    hostname: resolver
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-resolver
    networks:
      mail_internal:
        ipv4_address: 192.168.200.254


  webmail:
    container_name: webmail
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}webmail:${MAILU_VERSION:-2024.06}
    hostname: webmail
    restart: always
    env_file: mailu.env
    networks:
      - mail_internal
      - traefik_network
    dns:
      - 192.168.200.254
    logging:
      driver: journald
    depends_on:
      - admin
      - resolver
    volumes:
      - ./webmail:/data


  admin:
    container_name: admin
    image: ghcr.io/mailu/admin:2024.06
    hostname: admin
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-admin
    volumes:
      - ./data:/data
      - ./dkim:/dkim
    networks:
      - mail_internal
      - traefik_network
    depends_on:
      - redis
      - resolver
    dns:
      - 192.168.200.254


  imap:
    container_name: imap
    image: ghcr.io/mailu/dovecot:2024.06
    hostname: imap
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-imap
    volumes:
      - ./mail:/mail
    networks:
      - mail_internal
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.200.254


  smtp:
    container_name: smtp
    image: ghcr.io/mailu/postfix:2024.06
    hostname: smtp
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: smtp
    volumes:
      - ./mailqueue:/queue
      - ./dkim:/dkim
#      - ./overrides:/overrides:ro
    networks:
      - mail_internal
      - traefik_network
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.200.254


  oletools:
    container_name: oletools
    image: ghcr.io/mailu/oletools:2024.06
    hostname: oletools
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-oletools
    networks:
      - mail_internal
    depends_on:
      - resolver
    dns:
      - 192.168.200.254


  antispam:
    container_name: antispam
    image: ghcr.io/mailu/rspamd:2024.06
    hostname: antispam
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-antispam
    networks:
      - mail_internal
    volumes:
      - ./rspamd:/var/lib/rspamd
      - ./dkim:/dkim
    depends_on:
      - front
      - redis
      - oletools
      - resolver
    dns:
      - 192.168.200.254

  mta-sts:
    container_name: mta-sts
    image: nginx:alpine
    restart: always
    volumes:
      - ./mta-sts/.well-known:/usr/share/nginx/html/.well-known:ro
    networks:
      - mail_internal
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mta-sts.rule=Host(`mta-sts.roudin.de`)"
      - "traefik.http.routers.mta-sts.entrypoints=WEBSECURE"
      - "traefik.http.routers.mta-sts.tls=true"
      - "traefik.http.routers.mta-sts.tls.certresolver=LETS_ENCRYPT_RESOLVER"
      - "traefik.http.services.mta-sts.loadbalancer.server.port=80"

networks:
  mail_internal:
    external: true
    name: mail_internal
  traefik_network:
    external: true
    name: traefik_network
